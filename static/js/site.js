// Generated by CoffeeScript 1.6.3
(function() {
  var Theory, URL, audioContext, bpm, bps, cancelAnimationFrame, colorScale, d, enter, exercise, initInstrument, instrument, interval, major, makePromise, notes, parent, performance, requestAnimationFrame, start, startId, timeline, update, w, xpos, _d, _ref,
    __slice = [].slice;

  _d = d = (_ref = typeof console !== "undefined" && console !== null ? console.log.bind(console) : void 0) != null ? _ref : function() {};

  d3.selection.prototype.moveToFront = function() {
    return this.each(function() {
      return this.parentNode.appendChild(this);
    });
  };

  d3.selection.prototype.moveToBack = function() {
    return this.each(function() {
      return this.parentNode.insertBefore(this, this.parentNode.firstChild);
    });
  };

  performance = performance || {};

  performance.now = performance.now || performance.webkitNow || performance.msNow || performance.oNow || performance.mozNow || Date.now;

  requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function(cb) {
    return setTimeout(cb, 16);
  };

  cancelAnimationFrame = window.cancelAnimationFrame || window.webkitCancelAnimationFrame || window.mozCancelAnimationFrame || window.oCancelAnimationFrame || window.msCancelAnimationFrame || function(num) {
    return clearTimeout(num);
  };

  URL = window.URL || window.webkitURL || window.mozURL || window.oURL || window.msURL;

  audioContext = window.audioContext || window.webkitAudioContext || window.mozAudioContext || window.oAudioContext || window.msAudioContext;

  Theory = function() {};

  notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

  major = function(start) {
    var incs, offsets;
    incs = [0, 2, 2, 1, 2, 2, 2];
    offsets = (function(note) {
      var inc, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = incs.length; _i < _len; _i++) {
        inc = incs[_i];
        _results.push(note += inc);
      }
      return _results;
    })(0);
    return offsets.map(function(offset) {
      return start + offset;
    });
  };

  makePromise = function(fn) {
    var defer;
    defer = Q.defer();
    fn(defer);
    return defer.promise;
  };

  initInstrument = function() {
    var dispatch, fulfillWhen, tag;
    dispatch = d3.dispatch('ready', 'keydown', 'keyup', 'error');
    navigator.requestMIDIAccess().then(function(midi) {
      var inputs;
      inputs = midi.inputs();
      if (inputs.length) {
        inputs[0].onmidimessage = function(e) {
          var cmd, key, velocity, _ref1;
          _ref1 = e.data, cmd = _ref1[0], key = _ref1[1], velocity = _ref1[2];
          if (cmd === 144 && velocity > 0) {
            d('Key down:', key);
            return dispatch.keydown({
              key: key,
              velocity: velocity,
              time: e.receivedTime,
              event: e
            });
          } else if (cmd === 128 || (cmd === 144 && velocity === 0)) {
            return dispatch.keyup({
              key: key,
              time: e.receivedTime,
              event: e
            });
          }
        };
        d('Ready:', inputs[0]);
        return dispatch.ready(dispatch, inputs[0]);
      } else {
        return dispatch.error(true, null);
      }
    }, function(err) {
      return dispatch.error(false, err);
    });
    tag = (function() {
      var next;
      next = 0;
      return function(type) {
        return type + '.internal_' + next++;
      };
    })();
    fulfillWhen = function(defer, type, condition) {
      type = tag(type);
      return dispatch.on(type, function() {
        var args;
        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        if (condition.apply(null, args)) {
          defer.resolve();
          return dispatch.on(type, null);
        }
      });
    };
    dispatch.fakeKeys = function(keys) {
      var down, up;
      up = down = 0;
      return d3.select(document).on('keydown.instrument', function() {
        var _ref1;
        return dispatch.keydown({
          key: (_ref1 = keys[down++]) != null ? _ref1 : 72,
          velocity: 50,
          time: performance.now(),
          event: null
        });
      }).on('keyup.instrument', function() {
        var _ref1;
        return dispatch.keyup({
          key: (_ref1 = keys[up++]) != null ? _ref1 : 72,
          time: performance.now(),
          event: null
        });
      });
    };
    dispatch.watch = function(name, listener) {
      var id;
      id = tag(name);
      dispatch.on(id, listener);
      return id;
    };
    dispatch.unwatch = function(id) {
      return dispatch.on(id, null);
    };
    dispatch.waitForPress = function(key) {
      d('waiting for', key);
      return makePromise(function(defer) {
        return fulfillWhen(defer, 'keydown', function(e) {
          return e.key === key;
        });
      });
    };
    return dispatch;
  };

  exercise = {
    notes: _.flatten([major(60), major(72), 72 + 12, major(72).reverse()])
  };

  d('Exercise:', exercise);

  instrument = initInstrument();

  bpm = 120;

  bps = bpm / 60;

  interval = 1000 / bps;

  notes = exercise.notes.map(function(key, index) {
    return {
      key: key,
      index: index,
      offset: index * interval
    };
  });

  w = 900;

  xpos = d3.scale.linear().domain([0, notes.length - 1]).range([0, w]);

  parent = d3.select('#notes').append('g').attr('transform', 'translate(25, 225)');

  update = parent.selectAll('.note').data(notes);

  enter = update.enter().append('g').attr({
    "class": 'note',
    transform: function(d, i) {
      return "translate(" + (xpos(i)) + ", 0)";
    }
  });

  enter.append('circle').attr({
    "class": 'indicator',
    r: 3,
    fill: '#fff',
    cy: function(d) {
      return -5 * (d.key - notes[0].key);
    }
  });

  enter.append('circle').attr({
    "class": 'anim',
    r: 3,
    fill: '#fff',
    'fill-opacity': 1,
    cy: function(d) {
      return -5 * (d.key - notes[0].key);
    }
  });

  update.each(function(d) {
    return d.sel = d3.select(this);
  });

  colorScale = d3.scale.linear().domain([-10, 0, 10]).range(['#ff0000', '#fff', '#009eff']).interpolate(d3.interpolateLab).clamp(true);

  timeline = parent.append('line').attr({
    "class": 'timeline',
    x1: 0,
    y1: -25,
    x2: 0,
    y2: 25,
    stroke: '#fff'
  });

  start = function() {
    var duration, endTime, error, notePlayed, startTime, timeToXAxis;
    startTime = performance.now();
    duration = interval * (notes.length - 1);
    endTime = startTime + duration;
    timeline.transition().duration(duration).ease('linear').attr({
      transform: "translate(" + w + ", 0)",
      fill: '#fff'
    });
    timeToXAxis = d3.scale.linear().domain([0, duration]).range([0, w]);
    error = function(target, val) {
      return timeToXAxis(target - val);
    };
    notePlayed = function(note, time) {
      var err;
      note.sel.select('.anim').transition().ease('cubic-out').duration(600).attr('r', 20).attr('fill-opacity', 1e-6);
      err = error(time, startTime + note.offset);
      note.sel.moveToBack();
      note.sel.select('.indicator').transition().ease('cubic-out').duration(200).attr('fill', colorScale(err)).attr('r', 3 + Math.abs(err));
      return note.pressedAt = time;
    };
    instrument.on('keydown', function(e) {
      var index, nextNote, now, prevNote, selectedNote;
      now = performance.now();
      index = Math.floor((now - startTime) / interval);
      prevNote = notes[index];
      nextNote = notes[index + 1];
      if ((prevNote != null) && (prevNote.pressedAt == null) && prevNote.key === e.key) {
        selectedNote = prevNote;
      }
      if ((nextNote != null) && (nextNote.pressedAt == null) && nextNote.key === e.key) {
        selectedNote = nextNote;
      }
      if (selectedNote) {
        return notePlayed(selectedNote, e.time);
      }
    });
    return notePlayed(notes[0], startTime);
  };

  instrument.fakeKeys(exercise.notes);

  startId = instrument.watch('keydown', function() {
    start();
    return instrument.unwatch(startId);
  });

}).call(this);
