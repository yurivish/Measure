// Generated by CoffeeScript 1.6.3
(function() {
  var ascending, descending, exercise, indicate, initInstrument, major, noteIndicator, notes, sel, visExercise, visSection, _ref,
    __slice = [].slice;

  window._d = window.d = (_ref = typeof console !== "undefined" && console !== null ? console.log.bind(console) : void 0) != null ? _ref : function() {};

  notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

  major = function(start) {
    var incs, offsets;
    incs = [0, 2, 2, 1, 2, 2, 2];
    offsets = (function(note) {
      var inc, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = incs.length; _i < _len; _i++) {
        inc = incs[_i];
        _results.push(note += inc);
      }
      return _results;
    })(0);
    return offsets.map(function(offset) {
      return start + offset;
    });
  };

  ascending = _.flatten([major(60), major(72), 72 + 12]);

  descending = _.flatten([major(72).reverse(), major(60).reverse()]);

  exercise = [
    {
      direction: 'ascending',
      notes: ascending.map(function(key, index) {
        return {
          key: key,
          index: index
        };
      })
    }, {
      direction: 'descending',
      notes: descending.map(function(key, index) {
        return {
          key: key,
          index: index
        };
      })
    }
  ];

  d(exercise);

  sel = d3.select('#notes').append('g').attr('transform', 'translate(25, 25)');

  noteIndicator = sel.append('g').attr('transform', 'translate(950, 100)');

  noteIndicator.append('circle').attr({
    fill: '#333',
    stroke: '#333',
    r: 50
  });

  noteIndicator.append('text').attr({
    'text-anchor': 'middle',
    dy: '.35em',
    fill: '#fff'
  });

  indicate = function(note) {
    noteIndicator.select('text').text(note).attr('transform', 'scale(1.1)').interrupt().transition().duration(600).ease('cubic-out').attr('transform', 'scale(1)');
    return noteIndicator.select('circle').attr({
      stroke: '#888'
    }).interrupt().transition().duration(600).ease('cubic-out').attr({
      stroke: '#333'
    });
  };

  initInstrument = function() {
    var dispatch, fulfillWhen, tag;
    dispatch = d3.dispatch('ready', 'keydown', 'keyup', 'error');
    navigator.requestMIDIAccess().then(function(midi) {
      var inputs;
      inputs = midi.inputs();
      if (inputs.length) {
        inputs[0].onmidimessage = function(e) {
          var cmd, key, velocity, _ref1;
          _ref1 = e.data, cmd = _ref1[0], key = _ref1[1], velocity = _ref1[2];
          if (cmd === 144 && velocity > 0) {
            return dispatch.keydown({
              key: key,
              velocity: velocity,
              time: e.timeStamp,
              event: e
            });
          } else if (cmd === 128 || (cmd === 144 && velocity === 0)) {
            return dispatch.keyup({
              key: key,
              time: e.timeStamp,
              event: e
            });
          }
        };
        d('Ready:', inputs[0]);
        return dispatch.ready(dispatch, inputs[0]);
      } else {
        return dispatch.error(true, null);
      }
    }, function(err) {
      return dispatch.error(false, err);
    });
    d3.select(document).on('keydown', function() {
      return dispatch.keydown({
        key: 72,
        velocity: 50,
        time: Date.now(),
        event: null
      });
    }).on('keyup', function() {
      return dispatch.keyup({
        key: 72,
        time: Date.now(),
        event: null
      });
    });
    tag = (function() {
      var next;
      next = 0;
      return function(type) {
        return type + '.internal_' + next++;
      };
    })();
    fulfillWhen = function(defer, type, condition) {
      type = tag(type);
      return dispatch.on(type, function() {
        var args;
        args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
        if (condition.apply(null, args)) {
          defer.resolve();
          return dispatch.on(type, null);
        }
      });
    };
    dispatch.waitForPress = function(key) {
      d('waiting for', key);
      return makePromise(function(defer) {
        return fulfillWhen(defer, 'keydown', function(e) {
          return e.key === key;
        });
      });
    };
    return dispatch;
  };

  visExercise = function(exercise) {
    var enter, heightSoFar, i, pressed, rect, update;
    update = sel.selectAll('.section').data(exercise);
    enter = update.enter().append('g').attr({
      "class": 'section'
    });
    heightSoFar = 0;
    update.each(visSection).attr({
      transform: function(d, i) {
        var offset, padding, rect;
        padding = 25;
        offset = heightSoFar;
        rect = this.getBoundingClientRect();
        heightSoFar += rect.height + padding;
        return "translate(0, " + offset + ")";
      }
    });
    sel.selectAll('.note').attr({
      opacity: 1e-6
    }).transition().duration(600).delay(function(d, i) {
      return i * 20;
    }).attr({
      opacity: 1
    });
    rect = sel.node().getBoundingClientRect();
    d3.select('#notes').attr({
      height: rect.top + rect.height
    });
    i = 1;
    pressed = function() {
      var note, p, s, w;
      w = 800;
      p = 1;
      s = w / 8 - p;
      note = d3.select('.note:nth-child(' + i++ + ')');
      indicate(note.select('text').text());
      note.select('.after').transition().duration(400).ease('cubic-out').attr({
        width: s
      });
      return note.select('text').transition().duration(400).ease('cubic-out').attr('fill', '#000');
    };
    return initInstrument().on('keydown', pressed).on('error', function(instrumentMissing, err) {
      if (instrumentMissing) {
        return d('You have no MIDI keyboard.');
      } else {
        return d('Error initializing MIDI connection:', err);
      }
    });
  };

  visSection = function(section, i) {
    var enter, p, s, update, w;
    w = 800;
    p = 1;
    s = w / 8 - p;
    update = d3.select(this).selectAll('.note').data(section.notes);
    enter = update.enter().append('g').attr({
      "class": 'note'
    });
    enter.append('rect').attr({
      height: s,
      width: s,
      "class": 'before',
      fill: '#343434'
    });
    enter.append('rect').attr({
      height: s,
      width: 0,
      "class": 'after',
      fill: '#ccc'
    });
    enter.append('text').attr({
      'text-anchor': 'middle',
      x: s / 2,
      y: s / 2,
      dy: '.35em',
      fill: '#ddd'
    }).text(function() {
      return ['C', 'D', 'E', 'F#'][~~(Math.random() * 4)];
    });
    return update.attr({
      transform: function(d, i) {
        var x, y;
        x = i * (s + p) % w;
        y = (s + p) * (~~((i / w) * (s + p)));
        return "translate(" + x + ", " + y + ")";
      }
    }).on('mouseenter', function() {});
  };

  visExercise(exercise);

}).call(this);
